#######################################
#          –ú–µ–Ω—é –≤ Telegram            #
#######################################

- alias: Telegram Menu start
  id: telegram_menu_start
  description: "–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏ –ø–æ–∫–∞–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é"

  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: /start
    - platform: event
      event_type: telegram_callback
      event_data:
        command: /back

  action:
    - choose:
        - conditions:
            - condition: template
              value_template: '{{ trigger.event.data.command == "/start" }}'
          sequence:
            - service: telegram_bot.send_message
              data:
                message: &stmsg |
                  {{ [ "–ß—Ç–æ –∂–µ–ª–∞–µ—Ç–µ, –ü–æ–≤–µ–ª–∏—Ç–µ–ª—å?", "–ß—Ç–æ —è –º–æ–≥—É –¥–ª—è –í–∞—Å —Å–¥–µ–ª–∞—Ç—å?", "–í–Ω–∏–º–∞—é!", "–•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è" ] | random }}

                  {% if is_state("sun.sun", "above_horizon") -%} –°–æ–ª–Ω—Ü–µ —É–∂–µ –≤—Å—Ç–∞–ª–æ. 
                  {%- else -%} –°–æ–ª–Ω—Ü–µ –≤—Å—Ç–∞–Ω–µ—Ç –≤ {{ as_timestamp(state_attr("sun.sun", "next_rising")) | timestamp_custom('%H:%M') }}. {%- endif %}
                  –°–µ–π—á–∞—Å –∑–∞ –±–æ—Ä—Ç–æ–º {{ state_attr('weather.yandex_weather','yandex_condition') | lower }} {%- set current = states('sensor.openweathermap_weather_code') | int () %} 
                  {%- set conditions = { '\U0001F32B': [701, 741], '\U0001F329': [210, 211, 212, 221], '\U000026C8': [200, 201, 202, 230, 231, 232], '\U000026C5': [801, 802, 803, 804], '\U00002614': [504, 314, 502, 503, 522, 300, 301, 302, 310, 311, 312, 313, 500, 501, 520, 521, 906], '\U00002744': [600, 601, 602, 611, 612, 620, 621, 622], '\U00002614\U00002744': [511, 615, 616], '\U00002600': [800], '\U0001F4A8': [905, 951, 952, 953, 954, 955, 956, 957, 958, 959, 960, 961], '\U000026A0': [711, 721, 731, 751, 761, 762, 771, 900, 901, 962, 903, 904] } %} {%- for condition, value in conditions.items() %} {%- if current in value %} {{- " " + condition}} {%- endif %} {%- endfor %}
                  –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {{states('sensor.openweathermap_temperature') | int(0) }}¬∞C, –æ—â—É—â–∞–µ—Ç—Å—è {% if states('sensor.openweathermap_temperature') | int(0) == states('sensor.openweathermap_feels_like_temperature') | int(0) %}—Ç–∞–∫ –∂–µ. {% else %}–∫–∞–∫ {{states('sensor.openweathermap_feels_like_temperature') | int(0) }}¬∞C{% endif %}. –í–ª–∞–∂–Ω–æ—Å—Ç—å {{states('sensor.openweathermap_humidity')}} %.
                  –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ {{ states('sensor.openweathermap_wind_speed') | int(0) }} –º/—Å.
                  {%if states.light | selectattr('entity_id') |
                  selectattr('state','eq','on') | map(attribute='entity_id') | list | count == 0 %}–°–≤–µ—Ç –≤–µ–∑–¥–µ –≤—ã–∫–ª—é—á–µ–Ω.
                  {% else %}–°–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω.{% endif %}
                  –ó–∞–≤—Ç—Ä–∞
                  {%- if now().weekday() in (0,) %} –≤—Ç–æ—Ä–Ω–∏–∫ 
                  {%- elif now().weekday() in (1,) %} —Å—Ä–µ–¥–∞ 
                  {%- elif now().weekday() in (2,) %} —á–µ—Ç–≤–µ—Ä–≥ 
                  {%- elif now().weekday() in (3,) %} –ø—è—Ç–Ω–∏—Ü–∞ 
                  {%- elif now().weekday() in (4,) %} —Å—É–±–±–æ—Ç–∞ 
                  {%- elif now().weekday() in (5,) %} –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 
                  {%- elif now().weekday() in (6,) %} –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 
                  {%- endif -%},
                  {%- if is_state('binary_sensor.workday_tomorrow','on') and is_state('input_boolean.wakeup_disabled','off') %} —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å, {{ states('input_select.wakeup_time') | lower }}, 
                  {%- else %} –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å,
                  {%- endif %} –±—É–¥–∏–ª—å–Ω–∏–∫
                  {%- if is_state('input_boolean.wakeup_enabled','on') %} 
                    {%- if is_state('binary_sensor.workday_tomorrow','on') and is_state('input_boolean.wakeup_disabled','off') %} —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –≤
                      {%- if is_state('input_select.wakeup_time','–ú–µ—Ç—Ä–æ') %} {{ state_attr('input_datetime.wakeup_office_time', 'timestamp') | timestamp_custom('%H:%M', false) }}.
                      {%- elif is_state('input_select.wakeup_time','–ú–∞—à–∏–Ω–∞') %} {{ state_attr('input_datetime.wakeup_office_car_time', 'timestamp') | timestamp_custom('%H:%M', false) }}.
                      {%- elif is_state('input_select.wakeup_time','–°–∏–¥–∏–º –¥–æ–º–∞') %} {{ state_attr('input_datetime.wakeup_homeoffice_time', 'timestamp') | timestamp_custom('%H:%M', false) }}.
                      {%- endif -%}
                    {%- elif is_state('input_boolean.wakeup_weekend','on') and is_state('input_boolean.wakeup_disabled','on') %} —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ {{ state_attr('input_datetime.wakeup_weekend_time', 'timestamp') | timestamp_custom('%H:%M', false) }}
                    {%- else %} –≤—ã–∫–ª—é—á–µ–Ω.
                    {%- endif -%}
                  {%- else %} –≤—ã–∫–ª—é—á–µ–Ω.
                  {%- endif %}
                parse_mode: markdown
                disable_notification: true
                disable_web_page_preview: true
                timeout: 500
                inline_keyboard: &mainkeyb
                  - üí° –°–≤–µ—Ç:/lights, ‚è∞ –ë—É–¥–∏–ª—å–Ω–∏–∫:/wakeup
                  - ‚Ñπ –î–∞—Ç—á–∏–∫–∏:/status, üíª –°–∏—Å—Ç–µ–º–∞:/system
                  - ü¶æ –ó–∞–ø—É—Å—Ç–∏—Ç—å —É–±–æ—Ä–∫—É:/vacuum_start
                  - ‚ò¢Ô∏è –†–∞–¥–∏–∞—Ü–∏—è:/radiation, üì∏ –§–æ—Ç–æ —Å –¥–æ–º–æ—Ñ–æ–Ω–∞:/photo_entrance
                target: "{{ trigger.event.data.chat_id }}"
        - conditions:
            - condition: template
              value_template: '{{ trigger.event.data.command == "/back" }}'
          sequence:
            - service: telegram_bot.edit_message
              data:
                message_id: last
                chat_id: "{{ trigger.event.data.chat_id }}"
                message: *stmsg
                inline_keyboard: *mainkeyb
                target: "{{ trigger.event.data.chat_id }}"
  mode: single
